// app/api/bkash/payment/create/route.js
import axios from "axios";
import { NextResponse } from "next/server";
import { setValue, getValue, unsetValue, flush } from "node-global-storage";
import { v4 as uuidv4 } from "uuid";
import { connectDB } from "@/app/lib/connectDB";

// Middleware-like wrapper
export function withBkashAuth(handler) {
    return async (req) => {
        unsetValue("id_token");

        try {
            const { data } = await axios.post(
                process.env.bkash_grant_token_url,
                {
                    app_key: process.env.bkash_api_key,
                    app_secret: process.env.bkash_secret_key,
                },
                {
                    headers: {
                        "Content-Type": "application/json",
                        Accept: "application/json",
                        username: process.env.bkash_username,
                        password: process.env.bkash_password,
                    },
                }
            );

            const token = data.id_token;
            setValue("id_token", token, { protected: true });
            return handler(req, token);
        } catch (error) {
            console.error("bKash auth failed:", error.message);
            return NextResponse.json(
                { error: "Unauthorized", details: error.message },
                { status: 401 }
            );
        }
    };
}

// Your actual route handler
async function handler(req, bkashToken) {
    const body = await req.json();
    const { amount, orderID } = body;
    const db = await connectDB();
    const paymentsCollection = db.collection('payments');

    try {
        const merchantInvoiceNumber = "Inv" + uuidv4().substring(0, 8);

        // Create payment record before initiating bKash payment
        const paymentData = {
            orderID: parseInt(orderID),
            amount: parseFloat(amount),
            currency: "BDT",
            status: "initiated",
            paymentMethod: "bkash",
            merchantInvoiceNumber,
            createdAt: new Date(),
            updatedAt: new Date(),
        };

        const paymentResult = await paymentsCollection.insertOne(paymentData);
        const paymentId = paymentResult.insertedId;

        const { data } = await axios.post(
            process.env.bkash_create_payment_url,
            {
                mode: "0011",
                payerReference: " ",
                callbackURL: `${process.env.API_URL}/api/bkash/payment/callback`,
                amount: amount,
                currency: "BDT",
                intent: "sale",
                merchantInvoiceNumber: merchantInvoiceNumber,
            },
            {
                headers: await bkashHeaders(),
            }
        );

        // Update payment record with bKash payment ID
        await paymentsCollection.updateOne(
            { _id: paymentId },
            {
                $set: {
                    bkashPaymentID: data.paymentID,
                    updatedAt: new Date()
                }
            }
        );

        return NextResponse.json({
            bkashURL: data.bkashURL,
            paymentId: paymentId,
            merchantInvoiceNumber
        }, { status: 200 });

    } catch (error) {
        console.error("Payment creation error:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}

export const POST = withBkashAuth(handler);

export const bkashHeaders = async () => {
    return {
        "Content-Type": "application/json",
        Accept: "application/json",
        authorization: getValue('id_token'),
        'x-app-key': process.env.bkash_api_key,
    }
}